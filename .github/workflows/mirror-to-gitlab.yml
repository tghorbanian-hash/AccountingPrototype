name: Mirror to GitLab

on:
  push:
    branches: [ '**' ]
    tags: [ '**' ]
  create:
  delete:
  workflow_dispatch:          # دستی Run کن از تب Actions

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full GitHub repository (with all history and branches)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git user config (required for push)
        run: |
          git config --global user.name "GitHub Actions Mirror Bot"
          git config --global user.email "actions@github.com"

      - name: Mirror everything to GitLab (full sync)
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          # آدرس repo با توکن از secret (oauth2: پیشوند استاندارد برای PAT در GitLab)
          GITLAB_REPO_URL="https://oauth2:${GITLAB_TOKEN}@gitlab.com/next-top-tech/accounting/accounting-prototype.git"
          
          # اضافه کردن remote (اگر وجود داشت ignore می‌کنه)
          git remote add gitlab "${GITLAB_REPO_URL}" || true
          
          # تلاش اول بدون force (برای debug بهتر)
          git push gitlab --all || echo "Normal push --all failed → going to force mirror"
          git push gitlab --tags || echo "Normal push --tags failed → going to force"
          
          # mirror کامل + force (این معمولاً کار می‌کنه اگر auth درست باشه)
          git push gitlab --mirror --force
